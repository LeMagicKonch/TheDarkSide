# **Veracrypt Password Stealer**

# **Setting Up Veracrypt**

1. Install veracrypt
2. create a new DB file (*C:\Windows\test\testDB*)
3. Create a new volume
4. Ensure you give a unique password to the new volume to make it easy to find
5. Mount the new volume

# **VCsniff Payload**

Purpose:

- This payload will hook API associated with the password for the drives 

## **Recon**

Resource Links:
- API Monitor (http://www.rohitab.com/apimonitor)

What you will need:
- Veracrypt installed and new volume created and mounted
- API Monitor tool installed

Question to answer:

Which API calls do we want to monitor?

API Calls to monitor for this project:
- NT Native
- Windows Application UI Development

Steps:
1. Start Veracrypt
2. Find *Veracrypt* in the *Running Process* tab in the lower left
3. *Right-Click* veracrypt and select *Start Monitoring*
4. You will see the top right log start to populate
5. Mount the test database *testDB* that we created, entering the password
6. Once mounted we can stop monitoring
7. In the *Monitored Processes* tab, *Right-Click* veracrypt, select *stop monitoring*
8. In the log panel (top right), click the binoculars to search for the password we used *TESTMODEdrive*
9. We see only one API Call!
10. API Call was *WideCharToMultiByte*
11. Look up the API in the *Windows Documentation*
12. *Right-Click* the API Call in the log panel (Top Right) and click *copy*
13. Paste the copied call log into *Notepad++*
14. In the *Parameters* panel (panel below logs in far right), *right-click* and select *select all* and copy also pasting this into *Notepad++*

## **Create Hooking Payload**

Template to use:
- Hooking Template --> Detours Template

See the *vcsniff.cpp* file in this repo and comments will be located in the code.

## **Testing the Payload**

1. Open *DebugView* from SysInternals Suite to catch the debug messages we added
2. Open *Process Hacker* to inject the DLL into veracrypt
3. Open *VeraCrypt*
4. Find the *VeraCrypt* process in *Process Hacker*, *Right-Click* and select *Miscillaneous* and *Inject DLL* and choose the *vcsniff.dll* we created
5. You should see the message in *DebugView* that it was hooked
6. Mount the test drive using the password in *VeraCrypt*
7. You should see the captured password!
8. Unload the *vcsniff.dll* by finding the *VeraCrypt* process in *Process Hacker*, *Right-Click* and select *Properties*, Go to *Modules*, Find the *vcsniff.dll*, *Right-Click* and select *unload*

## **Storing the Stolen Password to Disk**

We will user the *CreateFile* and *WriteFile* WINAPI functions to accomplish this. 

I am saving into the *C:\Windows\Temp* directory.  

Can you figure out how to save to *C:\Users\<user>\AppData\Local\Temp*?

# **VCmigrate Payload**

Purpose:

Migrate from 32-bit process *OneDrive* to 64-bit process *VeraCrypt*

Why use *OneDrive*?

OneDrive is expected to execute network communications.

## **Templates Used**

1. WOW64 to Migrate
2. sRDI to convert vcsniff.dll into shellcode and call DllMain

## **Convert vcsniff.dll to Export DllMain**

We need to export *DllMain* from *vcsniff.dll* so we can use it in *vcmigrate* as a reflective DLL.

Check the call to *DlMain* in the source code of *vcsniff* to see how we did that.

You can confirm that a *DllMain* is being export with:

```
dumpbin /exports vcsniff.dll
```

## **Convert vcsniff.dll into Shellcode**

We will be using the *sRDI* tool for this.

Command:

```
python ..\sRDI\python\ConvertToShellcode.py -f DllMain <path to vcsniff.dll>
```

## **Encrypt the Shellcode with AES Encryption**

We need to encrypt the shellcode now that sRDI gave us.

Command:

```
.\aes.py vcsniff.bin > out.txt
```

## **Editing Source Code of WOW64migrate Template**

Check comments in the *vcmigrate.cpp* file for more info

**NOTE:**

Beacuse we are using *Heaven's Gate* to Migrate from a 32-bit to 64-bit process, we need to compile *vcmigrate.cpp* using the *x86 Native Tools Command Prompt*
